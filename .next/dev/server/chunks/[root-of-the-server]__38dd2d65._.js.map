{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink%20SMS/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {\n    throw new Error(\n      \"Supabase URL and Anon Key are required. Please check your environment variables in the Vars section.\",\n    )\n  }\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n          // This can be ignored if you have middleware refreshing\n          // user sessions.\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,2QAAO;IAEjC;;IAMA,OAAO,IAAA,8SAAkB,sUAAkF;QACzG,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 86, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink%20SMS/lib/resend.ts"],"sourcesContent":["import { Resend } from \"resend\";\n\nconst resend = new Resend(process.env.RESEND_API_KEY);\n\nexport default resend;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,SAAS,IAAI,gQAAM,CAAC,QAAQ,GAAG,CAAC,cAAc;uCAErC"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink%20SMS/lib/email.ts"],"sourcesContent":["import resend from \"./resend\";\r\n\r\ntype SendEmailOptions = {\r\n  from?: string;\r\n  to: string;\r\n  subject: string;\r\n  html?: string;\r\n  maxRetries?: number;\r\n};\r\n\r\nasync function sleep(ms: number) {\r\n  return new Promise((res) => setTimeout(res, ms));\r\n}\r\n\r\nexport async function sendEmail(options: SendEmailOptions) {\r\n  const from = options.from || process.env.EMAIL_FROM || \"Digilink IT Solutions <info@digilinkict.co.za>\";\r\n  const maxRetries = options.maxRetries ?? 3;\r\n\r\n  let attempt = 0;\r\n  let lastError: any = null;\r\n\r\n  while (attempt <= maxRetries) {\r\n    try {\r\n      const result = await resend.emails.send({\r\n        from,\r\n        to: options.to,\r\n        subject: options.subject,\r\n        html: options.html,\r\n      });\r\n\r\n      // Resend returns an object with possible `error`\r\n      if ((result as any).error) {\r\n        lastError = (result as any).error;\r\n        throw lastError;\r\n      }\r\n\r\n      return { success: true, data: result };\r\n    } catch (err: any) {\r\n      lastError = err;\r\n      attempt += 1;\r\n\r\n      // Exponential backoff: 500ms * 2^(attempt-1)\r\n      const delay = 500 * Math.pow(2, attempt - 1);\r\n      console.warn(`[email] send attempt ${attempt} failed. Retrying in ${delay}ms.`, err?.message || err);\r\n\r\n      if (attempt > maxRetries) {\r\n        console.error(`[email] all ${maxRetries} retries failed.`, lastError?.message || lastError);\r\n        return { success: false, error: lastError };\r\n      }\r\n\r\n      // wait before retry\r\n      // eslint-disable-next-line no-await-in-loop\r\n      await sleep(delay);\r\n    }\r\n  }\r\n\r\n  return { success: false, error: lastError };\r\n}\r\n\r\nexport default sendEmail;\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAUA,eAAe,MAAM,EAAU;IAC7B,OAAO,IAAI,QAAQ,CAAC,MAAQ,WAAW,KAAK;AAC9C;AAEO,eAAe,UAAU,OAAyB;IACvD,MAAM,OAAO,QAAQ,IAAI,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI;IACvD,MAAM,aAAa,QAAQ,UAAU,IAAI;IAEzC,IAAI,UAAU;IACd,IAAI,YAAiB;IAErB,MAAO,WAAW,WAAY;QAC5B,IAAI;YACF,MAAM,SAAS,MAAM,0HAAM,CAAC,MAAM,CAAC,IAAI,CAAC;gBACtC;gBACA,IAAI,QAAQ,EAAE;gBACd,SAAS,QAAQ,OAAO;gBACxB,MAAM,QAAQ,IAAI;YACpB;YAEA,iDAAiD;YACjD,IAAI,AAAC,OAAe,KAAK,EAAE;gBACzB,YAAY,AAAC,OAAe,KAAK;gBACjC,MAAM;YACR;YAEA,OAAO;gBAAE,SAAS;gBAAM,MAAM;YAAO;QACvC,EAAE,OAAO,KAAU;YACjB,YAAY;YACZ,WAAW;YAEX,6CAA6C;YAC7C,MAAM,QAAQ,MAAM,KAAK,GAAG,CAAC,GAAG,UAAU;YAC1C,QAAQ,IAAI,CAAC,CAAC,qBAAqB,EAAE,QAAQ,qBAAqB,EAAE,MAAM,GAAG,CAAC,EAAE,KAAK,WAAW;YAEhG,IAAI,UAAU,YAAY;gBACxB,QAAQ,KAAK,CAAC,CAAC,YAAY,EAAE,WAAW,gBAAgB,CAAC,EAAE,WAAW,WAAW;gBACjF,OAAO;oBAAE,SAAS;oBAAO,OAAO;gBAAU;YAC5C;YAEA,oBAAoB;YACpB,4CAA4C;YAC5C,MAAM,MAAM;QACd;IACF;IAEA,OAAO;QAAE,SAAS;QAAO,OAAO;IAAU;AAC5C;uCAEe"}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink%20SMS/app/api/notifications/send-renewal-reminder/route.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\";\nimport { NextResponse } from \"next/server\";\nimport sendEmail from \"@/lib/email\";\n\nexport async function POST(request: Request) {\n  try {\n    const supabase = await createClient();\n\n    // Fetch all subscriptions with renewal dates in the next 60 days\n    const now = new Date();\n    const maxDays = 60;\n    const windowEnd = new Date(now.getTime() + maxDays * 24 * 60 * 60 * 1000);\n\n    const { data: subscriptions } = await supabase\n      .from(\"subscriptions\")\n      .select(\"*, admin_id, admins(email)\")\n      .not(\"renewal_date\", \"is\", null)\n      .lte(\"renewal_date\", windowEnd.toISOString().split(\"T\")[0])\n      .gte(\"renewal_date\", now.toISOString().split(\"T\")[0]);\n\n    if (!subscriptions || subscriptions.length === 0) {\n      return NextResponse.json({ message: \"No renewals to remind about\" });\n    }\n\n    // Check for existing alerts to avoid duplicates for specific reminder days\n    const alertIds = (subscriptions || []).map((s) => s.id);\n\n    const { data: existingAlerts } = await supabase\n      .from(\"subscription_alerts\")\n      .select(\"subscription_id, alert_type\")\n      .in(\"subscription_id\", alertIds);\n\n    // Map of \"<subscriptionId>:<alert_type>\" for quick lookup\n    const existingAlertSet = new Set(\n      (existingAlerts || []).map((a: any) => `${a.subscription_id}:${a.alert_type}`)\n    );\n\n    const newReminders = (subscriptions || []).filter((s) => {\n      // We'll decide per-subscription whether to send, based on daysUntilRenewal\n      return true;\n    });\n\n    const sentEmails = [];\n    const failedEmails = [];\n\n    // Send emails using Resend and create alert records\n    // Target reminder days (in days before renewal)\n    const reminderDays = [60, 30, 14, 7];\n\n    for (const subscription of newReminders) {\n      try {\n        const adminEmail = subscription.admins?.email || \"\";\n        const daysUntilRenewal = Math.ceil(\n          (new Date(subscription.renewal_date).getTime() - now.getTime()) /\n            (1000 * 60 * 60 * 24)\n        );\n        // Only send reminders for our configured reminder days\n        if (!reminderDays.includes(daysUntilRenewal)) {\n          continue;\n        }\n\n        const alertType = `renewal_reminder_${daysUntilRenewal}`;\n        const alertKey = `${subscription.id}:${alertType}`;\n\n        // Skip if this exact reminder has already been sent\n        if (existingAlertSet.has(alertKey)) {\n          continue;\n        }\n\n        const emailResult = await sendEmail({\n          from: process.env.EMAIL_FROM,\n          to: adminEmail,\n          subject: `Subscription Renewal Reminder: ${subscription.client_name} - ${daysUntilRenewal} days`,\n          html: `\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n              <div style=\"text-align: center; margin-bottom: 30px;\">\n                <img src=\"https://hebbkx1anhila5yf.public.blob.vercel-storage.com/fulllogo-mOQT2tMeyjnDurVpajl9RZRGkVfbQd.png\" alt=\"Digilink IT Solutions\" style=\"max-width: 250px; height: auto;\" />\n              </div>\n              <h2 style=\"color: #1e3a8a;\">Subscription Renewal Reminder</h2>\n              <p>A subscription renewal is coming up soon.</p>\n              <div style=\"background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6;\">\n                <p><strong>Client:</strong> ${subscription.client_name}</p>\n                <p><strong>Subscription Type:</strong> ${subscription.subscription_type}</p>\n                <p><strong>Renewal In:</strong> ${daysUntilRenewal} days</p>\n                <p><strong>Renewal Date:</strong> ${subscription.renewal_date}</p>\n                ${subscription.price ? `<p><strong>Price:</strong> $${subscription.price}</p>` : \"\"}\n              </div>\n              <p>Please log in to your subscription dashboard to confirm or update the renewal details.</p>\n              <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #666; font-size: 12px;\">\n                <p>Connecting You to the Digital World</p>\n              </div>\n            </div>\n          `,\n        });\n\n        if (!emailResult.success) {\n          failedEmails.push({\n            subscription: subscription.client_name,\n            reason: emailResult.error?.message || \"Unknown error\",\n          });\n        } else {\n          // Create alert record only if email sent successfully\n          await supabase.from(\"subscription_alerts\").insert({\n            subscription_id: subscription.id,\n            alert_type: alertType,\n            alert_day: daysUntilRenewal,\n          });\n\n          sentEmails.push({\n            admin: adminEmail,\n            subscription: subscription.client_name,\n            renewalOn: subscription.renewal_date,\n            daysUntil: daysUntilRenewal,\n          });\n\n          console.log(\n            `[EMAIL] Renewal reminder (${daysUntilRenewal}d) sent to ${adminEmail} for ${subscription.client_name}`\n          );\n        }\n      } catch (error) {\n        failedEmails.push({\n          subscription: subscription.client_name,\n          reason: error instanceof Error ? error.message : \"Unknown error\",\n        });\n      }\n    }\n\n    return NextResponse.json({\n      message: \"Renewal reminders processed\",\n      sent: sentEmails.length,\n      failed: failedEmails.length,\n      sentEmails,\n      failedEmails,\n    });\n  } catch (error) {\n    console.error(\"Error sending reminders:\", error);\n    return NextResponse.json(\n      { error: \"Failed to send reminders\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET() {\n  return NextResponse.json({\n    message: \"Email notification service for subscription renewal reminders\",\n  });\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,iEAAiE;QACjE,MAAM,MAAM,IAAI;QAChB,MAAM,UAAU;QAChB,MAAM,YAAY,IAAI,KAAK,IAAI,OAAO,KAAK,UAAU,KAAK,KAAK,KAAK;QAEpE,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,iBACL,MAAM,CAAC,8BACP,GAAG,CAAC,gBAAgB,MAAM,MAC1B,GAAG,CAAC,gBAAgB,UAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EACzD,GAAG,CAAC,gBAAgB,IAAI,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAEtD,IAAI,CAAC,iBAAiB,cAAc,MAAM,KAAK,GAAG;YAChD,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;YAA8B;QACpE;QAEA,2EAA2E;QAC3E,MAAM,WAAW,CAAC,iBAAiB,EAAE,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE;QAEtD,MAAM,EAAE,MAAM,cAAc,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,uBACL,MAAM,CAAC,+BACP,EAAE,CAAC,mBAAmB;QAEzB,0DAA0D;QAC1D,MAAM,mBAAmB,IAAI,IAC3B,CAAC,kBAAkB,EAAE,EAAE,GAAG,CAAC,CAAC,IAAW,GAAG,EAAE,eAAe,CAAC,CAAC,EAAE,EAAE,UAAU,EAAE;QAG/E,MAAM,eAAe,CAAC,iBAAiB,EAAE,EAAE,MAAM,CAAC,CAAC;YACjD,2EAA2E;YAC3E,OAAO;QACT;QAEA,MAAM,aAAa,EAAE;QACrB,MAAM,eAAe,EAAE;QAEvB,oDAAoD;QACpD,gDAAgD;QAChD,MAAM,eAAe;YAAC;YAAI;YAAI;YAAI;SAAE;QAEpC,KAAK,MAAM,gBAAgB,aAAc;YACvC,IAAI;gBACF,MAAM,aAAa,aAAa,MAAM,EAAE,SAAS;gBACjD,MAAM,mBAAmB,KAAK,IAAI,CAChC,CAAC,IAAI,KAAK,aAAa,YAAY,EAAE,OAAO,KAAK,IAAI,OAAO,EAAE,IAC5D,CAAC,OAAO,KAAK,KAAK,EAAE;gBAExB,uDAAuD;gBACvD,IAAI,CAAC,aAAa,QAAQ,CAAC,mBAAmB;oBAC5C;gBACF;gBAEA,MAAM,YAAY,CAAC,iBAAiB,EAAE,kBAAkB;gBACxD,MAAM,WAAW,GAAG,aAAa,EAAE,CAAC,CAAC,EAAE,WAAW;gBAElD,oDAAoD;gBACpD,IAAI,iBAAiB,GAAG,CAAC,WAAW;oBAClC;gBACF;gBAEA,MAAM,cAAc,MAAM,IAAA,yHAAS,EAAC;oBAClC,MAAM,QAAQ,GAAG,CAAC,UAAU;oBAC5B,IAAI;oBACJ,SAAS,CAAC,+BAA+B,EAAE,aAAa,WAAW,CAAC,GAAG,EAAE,iBAAiB,KAAK,CAAC;oBAChG,MAAM,CAAC;;;;;;;;4CAQ2B,EAAE,aAAa,WAAW,CAAC;uDAChB,EAAE,aAAa,iBAAiB,CAAC;gDACxC,EAAE,iBAAiB;kDACjB,EAAE,aAAa,YAAY,CAAC;gBAC9D,EAAE,aAAa,KAAK,GAAG,CAAC,4BAA4B,EAAE,aAAa,KAAK,CAAC,IAAI,CAAC,GAAG,GAAG;;;;;;;UAO1F,CAAC;gBACH;gBAEA,IAAI,CAAC,YAAY,OAAO,EAAE;oBACxB,aAAa,IAAI,CAAC;wBAChB,cAAc,aAAa,WAAW;wBACtC,QAAQ,YAAY,KAAK,EAAE,WAAW;oBACxC;gBACF,OAAO;oBACL,sDAAsD;oBACtD,MAAM,SAAS,IAAI,CAAC,uBAAuB,MAAM,CAAC;wBAChD,iBAAiB,aAAa,EAAE;wBAChC,YAAY;wBACZ,WAAW;oBACb;oBAEA,WAAW,IAAI,CAAC;wBACd,OAAO;wBACP,cAAc,aAAa,WAAW;wBACtC,WAAW,aAAa,YAAY;wBACpC,WAAW;oBACb;oBAEA,QAAQ,GAAG,CACT,CAAC,0BAA0B,EAAE,iBAAiB,WAAW,EAAE,WAAW,KAAK,EAAE,aAAa,WAAW,EAAE;gBAE3G;YACF,EAAE,OAAO,OAAO;gBACd,aAAa,IAAI,CAAC;oBAChB,cAAc,aAAa,WAAW;oBACtC,QAAQ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;gBACnD;YACF;QACF;QAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM,WAAW,MAAM;YACvB,QAAQ,aAAa,MAAM;YAC3B;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA2B,GACpC;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe;IACpB,OAAO,+QAAY,CAAC,IAAI,CAAC;QACvB,SAAS;IACX;AACF"}}]
}