module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$84$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.7.0_@supabase+supabase-js@2.84.0/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$84$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.7.0_@supabase+supabase-js@2.84.0/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$3_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.3_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
async function createClient() {
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$3_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
    ;
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$84$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://lmromhvsztedrlztxsjc.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtcm9taHZzenRlZHJsenR4c2pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NDY2MTUsImV4cCI6MjA3OTEyMjYxNX0.0MAdoBMjDGXbgGLkX2xbdsmDhUhqI7d9L1nclj_sKZk"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>cookieStore.set(name, value, options));
                } catch  {
                // The "setAll" method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
}
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[project]/lib/resend.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "default",
    ()=>__TURBOPACK__default__export__
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$resend$40$6$2e$5$2e$2_$40$react$2d$email$2b$r_b8c1cf2d9e5220efae0c510eb1d234cf$2f$node_modules$2f$resend$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/resend@6.5.2_@react-email+r_b8c1cf2d9e5220efae0c510eb1d234cf/node_modules/resend/dist/index.mjs [app-route] (ecmascript)");
;
const resend = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$resend$40$6$2e$5$2e$2_$40$react$2d$email$2b$r_b8c1cf2d9e5220efae0c510eb1d234cf$2f$node_modules$2f$resend$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Resend"](process.env.RESEND_API_KEY);
const __TURBOPACK__default__export__ = resend;
}),
"[project]/lib/email.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "default",
    ()=>__TURBOPACK__default__export__,
    "sendEmail",
    ()=>sendEmail
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$resend$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/resend.ts [app-route] (ecmascript)");
;
async function sleep(ms) {
    return new Promise((res)=>setTimeout(res, ms));
}
async function sendEmail(options) {
    const from = options.from || process.env.EMAIL_FROM || "Digilink IT Solutions <info@digilinkict.co.za>";
    const maxRetries = options.maxRetries ?? 3;
    let attempt = 0;
    let lastError = null;
    while(attempt <= maxRetries){
        try {
            const result = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$resend$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].emails.send({
                from,
                to: options.to,
                subject: options.subject,
                html: options.html
            });
            // Resend returns an object with possible `error`
            if (result.error) {
                lastError = result.error;
                throw lastError;
            }
            return {
                success: true,
                data: result
            };
        } catch (err) {
            lastError = err;
            attempt += 1;
            // Exponential backoff: 500ms * 2^(attempt-1)
            const delay = 500 * Math.pow(2, attempt - 1);
            console.warn(`[email] send attempt ${attempt} failed. Retrying in ${delay}ms.`, err?.message || err);
            if (attempt > maxRetries) {
                console.error(`[email] all ${maxRetries} retries failed.`, lastError?.message || lastError);
                return {
                    success: false,
                    error: lastError
                };
            }
            // wait before retry
            // eslint-disable-next-line no-await-in-loop
            await sleep(delay);
        }
    }
    return {
        success: false,
        error: lastError
    };
}
const __TURBOPACK__default__export__ = sendEmail;
}),
"[project]/app/api/notifications/send-renewal-reminder/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$3_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.3_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/email.ts [app-route] (ecmascript)");
;
;
;
async function POST(request) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        // Fetch all subscriptions with renewal dates in the next 60 days
        const now = new Date();
        const maxDays = 60;
        const windowEnd = new Date(now.getTime() + maxDays * 24 * 60 * 60 * 1000);
        const { data: subscriptions } = await supabase.from("subscriptions").select("*, admin_id, admins(email)").not("renewal_date", "is", null).lte("renewal_date", windowEnd.toISOString().split("T")[0]).gte("renewal_date", now.toISOString().split("T")[0]);
        if (!subscriptions || subscriptions.length === 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$3_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: "No renewals to remind about"
            });
        }
        // Check for existing alerts to avoid duplicates for specific reminder days
        const alertIds = (subscriptions || []).map((s)=>s.id);
        const { data: existingAlerts } = await supabase.from("subscription_alerts").select("subscription_id, alert_type").in("subscription_id", alertIds);
        // Map of "<subscriptionId>:<alert_type>" for quick lookup
        const existingAlertSet = new Set((existingAlerts || []).map((a)=>`${a.subscription_id}:${a.alert_type}`));
        const newReminders = (subscriptions || []).filter((s)=>{
            // We'll decide per-subscription whether to send, based on daysUntilRenewal
            return true;
        });
        const sentEmails = [];
        const failedEmails = [];
        // Send emails using Resend and create alert records
        // Target reminder days (in days before renewal)
        const reminderDays = [
            60,
            30,
            14,
            7
        ];
        for (const subscription of newReminders){
            try {
                const adminEmail = subscription.admins?.email || "";
                const daysUntilRenewal = Math.ceil((new Date(subscription.renewal_date).getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                // Only send reminders for our configured reminder days
                if (!reminderDays.includes(daysUntilRenewal)) {
                    continue;
                }
                const alertType = `renewal_reminder_${daysUntilRenewal}`;
                const alertKey = `${subscription.id}:${alertType}`;
                // Skip if this exact reminder has already been sent
                if (existingAlertSet.has(alertKey)) {
                    continue;
                }
                const emailResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$email$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
                    from: process.env.EMAIL_FROM,
                    to: adminEmail,
                    subject: `Subscription Renewal Reminder: ${subscription.client_name} - ${daysUntilRenewal} days`,
                    html: `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
              <div style="text-align: center; margin-bottom: 30px;">
                <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/fulllogo-mOQT2tMeyjnDurVpajl9RZRGkVfbQd.png" alt="Digilink IT Solutions" style="max-width: 250px; height: auto;" />
              </div>
              <h2 style="color: #1e3a8a;">Subscription Renewal Reminder</h2>
              <p>A subscription renewal is coming up soon.</p>
              <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6;">
                <p><strong>Client:</strong> ${subscription.client_name}</p>
                <p><strong>Subscription Type:</strong> ${subscription.subscription_type}</p>
                <p><strong>Renewal In:</strong> ${daysUntilRenewal} days</p>
                <p><strong>Renewal Date:</strong> ${subscription.renewal_date}</p>
                ${subscription.price ? `<p><strong>Price:</strong> $${subscription.price}</p>` : ""}
              </div>
              <p>Please log in to your subscription dashboard to confirm or update the renewal details.</p>
              <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #666; font-size: 12px;">
                <p>Connecting You to the Digital World</p>
              </div>
            </div>
          `
                });
                if (!emailResult.success) {
                    failedEmails.push({
                        subscription: subscription.client_name,
                        reason: emailResult.error?.message || "Unknown error"
                    });
                } else {
                    // Create alert record only if email sent successfully
                    await supabase.from("subscription_alerts").insert({
                        subscription_id: subscription.id,
                        alert_type: alertType,
                        alert_day: daysUntilRenewal
                    });
                    sentEmails.push({
                        admin: adminEmail,
                        subscription: subscription.client_name,
                        renewalOn: subscription.renewal_date,
                        daysUntil: daysUntilRenewal
                    });
                    console.log(`[EMAIL] Renewal reminder (${daysUntilRenewal}d) sent to ${adminEmail} for ${subscription.client_name}`);
                }
            } catch (error) {
                failedEmails.push({
                    subscription: subscription.client_name,
                    reason: error instanceof Error ? error.message : "Unknown error"
                });
            }
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$3_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            message: "Renewal reminders processed",
            sent: sentEmails.length,
            failed: failedEmails.length,
            sentEmails,
            failedEmails
        });
    } catch (error) {
        console.error("Error sending reminders:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$3_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to send reminders"
        }, {
            status: 500
        });
    }
}
async function GET() {
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$3_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
        message: "Email notification service for subscription renewal reminders"
    });
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__38dd2d65._.js.map