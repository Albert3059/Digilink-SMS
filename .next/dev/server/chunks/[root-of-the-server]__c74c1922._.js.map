{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink%20SMS/app/api/reports/send-subscription-report/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Resend } from \"resend\"\n\nexport async function POST(request: Request) {\n  try {\n    console.log(\"[v0] Report API called\")\n\n    if (!process.env.RESEND_API_KEY) {\n      console.error(\"[v0] RESEND_API_KEY is not configured\")\n      return NextResponse.json({ error: \"Email service not configured\" }, { status: 500 })\n    }\n\n    const { subscriptions, adminEmail, companyName } = await request.json()\n\n    if (!subscriptions || !Array.isArray(subscriptions)) {\n      console.error(\"[v0] Invalid subscriptions data\")\n      return NextResponse.json({ error: \"Invalid subscriptions data\" }, { status: 400 })\n    }\n\n    if (!adminEmail) {\n      console.error(\"[v0] No admin email provided\")\n      return NextResponse.json({ error: \"Admin email is required\" }, { status: 400 })\n    }\n\n    const resend = new Resend(process.env.RESEND_API_KEY)\n\n    console.log(\"[v0] Preparing report for:\", adminEmail)\n\n    // Calculate statistics\n    const totalSubscriptions = subscriptions.length\n    const activeSubscriptions = subscriptions.filter((s) => s.status === \"active\").length\n    const expiredSubscriptions = subscriptions.filter((s) => s.status === \"expired\").length\n    const totalRevenue = subscriptions.reduce((sum, s) => sum + (Number.parseFloat(s.price) || 0), 0)\n\n    // Get subscriptions expiring in next 30 days\n    const today = new Date()\n    const thirtyDaysFromNow = new Date(today)\n    thirtyDaysFromNow.setDate(today.getDate() + 30)\n\n    const upcomingRenewals = subscriptions.filter((sub) => {\n      if (!sub.renewal_date) return false\n      const renewalDate = new Date(sub.renewal_date)\n      return renewalDate >= today && renewalDate <= thirtyDaysFromNow\n    })\n\n    // Generate HTML report\n    const reportHtml = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n          .container { max-width: 800px; margin: 0 auto; padding: 20px; }\n          .logo { text-align: center; margin-bottom: 30px; }\n          .logo img { max-width: 300px; height: auto; }\n          .header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; }\n          .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }\n          .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #1e3a8a; }\n          .stat-label { font-size: 14px; color: #666; margin-bottom: 5px; }\n          .stat-value { font-size: 32px; font-weight: bold; color: #333; }\n          table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n          th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }\n          th { background: #f8f9fa; font-weight: 600; }\n          .status { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n          .status.active { background: #d1fae5; color: #065f46; }\n          .status.expired { background: #fee2e2; color: #991b1b; }\n          .status.pending { background: #fef3c7; color: #92400e; }\n          .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #666; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"logo\">\n            <img src=\"/images/fulllogo.png\" alt=\"Digilink IT Solutions\" />\n          </div>\n          \n          <div class=\"header\">\n            <h1>Subscription Report</h1>\n            <p>${companyName || \"Digilink IT Solutions\"}</p>\n            <p>Generated on ${new Date().toLocaleDateString()}</p>\n          </div>\n\n          <div class=\"stats\">\n            <div class=\"stat-card\">\n              <div class=\"stat-label\">Total Subscriptions</div>\n              <div class=\"stat-value\">${totalSubscriptions}</div>\n            </div>\n            <div class=\"stat-card\">\n              <div class=\"stat-label\">Active Subscriptions</div>\n              <div class=\"stat-value\">${activeSubscriptions}</div>\n            </div>\n            <div class=\"stat-card\">\n              <div class=\"stat-label\">Expired Subscriptions</div>\n              <div class=\"stat-value\">${expiredSubscriptions}</div>\n            </div>\n            <div class=\"stat-card\">\n              <div class=\"stat-label\">Total Revenue</div>\n              <div class=\"stat-value\">$${totalRevenue.toFixed(2)}</div>\n            </div>\n          </div>\n\n          <h2>Upcoming Renewals (Next 30 Days)</h2>\n          ${\n            upcomingRenewals.length > 0\n              ? `\n            <table>\n              <thead>\n                <tr>\n                  <th>Client Name</th>\n                  <th>Type</th>\n                  <th>Renewal Date</th>\n                  <th>Price</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${upcomingRenewals\n                  .map(\n                    (sub) => `\n                  <tr>\n                    <td>${sub.client_name}</td>\n                    <td>${sub.subscription_type}</td>\n                    <td>${new Date(sub.renewal_date).toLocaleDateString()}</td>\n                    <td>$${Number.parseFloat(sub.price).toFixed(2)}</td>\n                  </tr>\n                `,\n                  )\n                  .join(\"\")}\n              </tbody>\n            </table>\n          `\n              : `<p>No upcoming renewals in the next 30 days.</p>`\n          }\n\n          <h2>All Subscriptions</h2>\n          <table>\n            <thead>\n              <tr>\n                <th>Client Name</th>\n                <th>Type</th>\n                <th>Status</th>\n                <th>End Date</th>\n                <th>Price</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${subscriptions\n                .map(\n                  (sub) => `\n                <tr>\n                  <td>${sub.client_name}</td>\n                  <td>${sub.subscription_type}</td>\n                  <td><span class=\"status ${sub.status}\">${sub.status}</span></td>\n                  <td>${new Date(sub.end_date).toLocaleDateString()}</td>\n                  <td>$${Number.parseFloat(sub.price).toFixed(2)}</td>\n                </tr>\n              `,\n                )\n                .join(\"\")}\n            </tbody>\n          </table>\n\n          <div class=\"footer\">\n            <p>This is an automated report from Digilink IT Solutions Subscription Management System</p>\n            <p style=\"font-size: 12px; margin-top: 10px;\">Connecting You to the Digital World</p>\n          </div>\n        </div>\n      </body>\n      </html>\n    `\n\n    console.log(\"[v0] Sending email to:\", adminEmail)\n\n    try {\n      const { data, error } = await resend.emails.send({\n        from: process.env.EMAIL_FROM || \"Digilink IT Solutions <info@digilinkict.co.za>\",\n        to: adminEmail,\n        subject: `Subscription Report - ${new Date().toLocaleDateString()}`,\n        html: reportHtml,\n      })\n\n      if (error) {\n        console.error(\"[v0] Resend API error:\", error)\n        return NextResponse.json(\n          { error: `Failed to send email: ${error.message || \"Unknown error\"}` },\n          { status: 500 },\n        )\n      }\n\n      console.log(\"[v0] Email sent successfully:\", data?.id)\n\n      return NextResponse.json({\n        message: \"Report sent successfully\",\n        emailId: data?.id,\n      })\n    } catch (emailError: any) {\n      console.error(\"[v0] Exception sending email:\", emailError)\n      return NextResponse.json(\n        { error: `Email service error: ${emailError.message || \"Unknown error\"}` },\n        { status: 500 },\n      )\n    }\n  } catch (error: any) {\n    console.error(\"[v0] Unexpected error generating report:\", error)\n    return NextResponse.json(\n      { error: `Failed to generate report: ${error.message || \"Unknown error\"}` },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}