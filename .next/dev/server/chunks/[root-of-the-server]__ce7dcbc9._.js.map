{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink-SMS/lib/resend.ts"],"sourcesContent":["import { Resend } from \"resend\";\n\nconst resend = new Resend(process.env.RESEND_API_KEY);\n\nexport default resend;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,SAAS,IAAI,gQAAM,CAAC,QAAQ,GAAG,CAAC,cAAc;uCAErC"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink-SMS/lib/email.ts"],"sourcesContent":["import resend from \"./resend\";\r\n\r\ntype SendEmailOptions = {\r\n  from?: string;\r\n  to: string;\r\n  subject: string;\r\n  html?: string;\r\n  maxRetries?: number;\r\n};\r\n\r\nasync function sleep(ms: number) {\r\n  return new Promise((res) => setTimeout(res, ms));\r\n}\r\n\r\nexport async function sendEmail(options: SendEmailOptions) {\r\n  const from = options.from || process.env.EMAIL_FROM || \"Digilink IT Subscription Management System <info@digilinkict.co.za>\";\r\n  const maxRetries = options.maxRetries ?? 3;\r\n\r\n  let attempt = 0;\r\n  let lastError: any = null;\r\n\r\n  while (attempt <= maxRetries) {\r\n    try {\r\n      const result = await resend.emails.send({\r\n        from,\r\n        to: options.to,\r\n        subject: options.subject,\r\n        html: options.html,\r\n      });\r\n\r\n      // Resend returns an object with possible `error`\r\n      if ((result as any).error) {\r\n        lastError = (result as any).error;\r\n        throw lastError;\r\n      }\r\n\r\n      return { success: true, data: result };\r\n    } catch (err: any) {\r\n      lastError = err;\r\n      attempt += 1;\r\n\r\n      // Exponential backoff: 500ms * 2^(attempt-1)\r\n      const delay = 500 * Math.pow(2, attempt - 1);\r\n      console.warn(`[email] send attempt ${attempt} failed. Retrying in ${delay}ms.`, err?.message || err);\r\n\r\n      if (attempt > maxRetries) {\r\n        console.error(`[email] all ${maxRetries} retries failed.`, lastError?.message || lastError);\r\n        return { success: false, error: lastError };\r\n      }\r\n\r\n      // wait before retry\r\n      // eslint-disable-next-line no-await-in-loop\r\n      await sleep(delay);\r\n    }\r\n  }\r\n\r\n  return { success: false, error: lastError };\r\n}\r\n\r\nexport default sendEmail;\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAUA,eAAe,MAAM,EAAU;IAC7B,OAAO,IAAI,QAAQ,CAAC,MAAQ,WAAW,KAAK;AAC9C;AAEO,eAAe,UAAU,OAAyB;IACvD,MAAM,OAAO,QAAQ,IAAI,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI;IACvD,MAAM,aAAa,QAAQ,UAAU,IAAI;IAEzC,IAAI,UAAU;IACd,IAAI,YAAiB;IAErB,MAAO,WAAW,WAAY;QAC5B,IAAI;YACF,MAAM,SAAS,MAAM,0HAAM,CAAC,MAAM,CAAC,IAAI,CAAC;gBACtC;gBACA,IAAI,QAAQ,EAAE;gBACd,SAAS,QAAQ,OAAO;gBACxB,MAAM,QAAQ,IAAI;YACpB;YAEA,iDAAiD;YACjD,IAAI,AAAC,OAAe,KAAK,EAAE;gBACzB,YAAY,AAAC,OAAe,KAAK;gBACjC,MAAM;YACR;YAEA,OAAO;gBAAE,SAAS;gBAAM,MAAM;YAAO;QACvC,EAAE,OAAO,KAAU;YACjB,YAAY;YACZ,WAAW;YAEX,6CAA6C;YAC7C,MAAM,QAAQ,MAAM,KAAK,GAAG,CAAC,GAAG,UAAU;YAC1C,QAAQ,IAAI,CAAC,CAAC,qBAAqB,EAAE,QAAQ,qBAAqB,EAAE,MAAM,GAAG,CAAC,EAAE,KAAK,WAAW;YAEhG,IAAI,UAAU,YAAY;gBACxB,QAAQ,KAAK,CAAC,CAAC,YAAY,EAAE,WAAW,gBAAgB,CAAC,EAAE,WAAW,WAAW;gBACjF,OAAO;oBAAE,SAAS;oBAAO,OAAO;gBAAU;YAC5C;YAEA,oBAAoB;YACpB,4CAA4C;YAC5C,MAAM,MAAM;QACd;IACF;IAEA,OAAO;QAAE,SAAS;QAAO,OAAO;IAAU;AAC5C;uCAEe"}},
    {"offset": {"line": 137, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink-SMS/lib/logo.ts"],"sourcesContent":["import fs from \"fs\";\r\nimport path from \"path\";\r\n\r\nexport function getEmbeddedLogoDataUrl(): string | null {\r\n  try {\r\n    const publicPath = path.join(process.cwd(), \"public\", \"digilink-logo.png\");\r\n    if (!fs.existsSync(publicPath)) return null;\r\n    const buffer = fs.readFileSync(publicPath);\r\n    const base64 = buffer.toString(\"base64\");\r\n    // assume PNG; change if you keep a different format\r\n    return `data:image/png;base64,${base64}`;\r\n  } catch (error) {\r\n    // fail silently and let callers fallback\r\n    return null;\r\n  }\r\n}\r\n\r\nexport default getEmbeddedLogoDataUrl;\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,SAAS;IACd,IAAI;QACF,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,UAAU;QACtD,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,aAAa,OAAO;QACvC,MAAM,SAAS,wGAAE,CAAC,YAAY,CAAC;QAC/B,MAAM,SAAS,OAAO,QAAQ,CAAC;QAC/B,oDAAoD;QACpD,OAAO,CAAC,sBAAsB,EAAE,QAAQ;IAC1C,EAAE,OAAO,OAAO;QACd,yCAAyC;QACzC,OAAO;IACT;AACF;uCAEe"}},
    {"offset": {"line": 165, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink-SMS/lib/format.ts"],"sourcesContent":["export function formatCurrency(value: number | string | null | undefined) {\r\n  const amount = typeof value === \"string\" ? Number.parseFloat(value) : Number(value)\r\n  const safe = Number.isFinite(amount) ? amount : 0\r\n\r\n  try {\r\n    return new Intl.NumberFormat(\"en-ZA\", { style: \"currency\", currency: \"ZAR\" }).format(safe)\r\n  } catch (err) {\r\n    // Fallback to simple formatting with R prefix\r\n    return `R${safe.toFixed(2)}`\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,eAAe,KAAyC;IACtE,MAAM,SAAS,OAAO,UAAU,WAAW,OAAO,UAAU,CAAC,SAAS,OAAO;IAC7E,MAAM,OAAO,OAAO,QAAQ,CAAC,UAAU,SAAS;IAEhD,IAAI;QACF,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;YAAE,OAAO;YAAY,UAAU;QAAM,GAAG,MAAM,CAAC;IACvF,EAAE,OAAO,KAAK;QACZ,8CAA8C;QAC9C,OAAO,CAAC,CAAC,EAAE,KAAK,OAAO,CAAC,IAAI;IAC9B;AACF"}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p.mkwanazi/OneDrive%20-%20Assupol%20Group/Documents/GitHub/Digilink-SMS/app/api/reports/send-subscription-report/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport sendEmail from \"@/lib/email\"\nimport { getEmbeddedLogoDataUrl } from \"@/lib/logo\"\nimport { formatCurrency } from \"@/lib/format\"\n\nexport async function POST(request: Request) {\n  try {\n    console.log(\"[v0] Report API called\")\n\n    if (!process.env.RESEND_API_KEY) {\n      console.error(\"[v0] RESEND_API_KEY is not configured\")\n      return NextResponse.json({ error: \"Email service not configured\" }, { status: 500 })\n    }\n\n    const { subscriptions, adminEmail, companyName } = await request.json()\n\n    if (!subscriptions || !Array.isArray(subscriptions)) {\n      console.error(\"[v0] Invalid subscriptions data\")\n      return NextResponse.json({ error: \"Invalid subscriptions data\" }, { status: 400 })\n    }\n\n    if (!adminEmail) {\n      console.error(\"[v0] No admin email provided\")\n      return NextResponse.json({ error: \"Admin email is required\" }, { status: 400 })\n    }\n\n    // Reuse sendEmail helper which uses the Resend client internally\n\n    console.log(\"[v0] Preparing report for:\", adminEmail)\n\n    // Calculate statistics\n    const totalSubscriptions = subscriptions.length\n    const activeSubscriptions = subscriptions.filter((s) => s.status === \"active\").length\n    const expiredSubscriptions = subscriptions.filter((s) => s.status === \"expired\").length\n    const totalRevenue = subscriptions.reduce((sum, s) => sum + (Number.parseFloat(s.price) || 0), 0)\n\n    // Get subscriptions expiring in next 30 days\n    const today = new Date()\n    const thirtyDaysFromNow = new Date(today)\n    thirtyDaysFromNow.setDate(today.getDate() + 30)\n\n    const upcomingRenewals = subscriptions.filter((sub) => {\n      if (!sub.renewal_date) return false\n      const renewalDate = new Date(sub.renewal_date)\n      return renewalDate >= today && renewalDate <= thirtyDaysFromNow\n    })\n\n    // Resolve logo URL (use deployed site URL if available, otherwise fall back to public root)\n    const logoUrl = process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || \"\"\n    const embedLogo = process.env.EMBED_LOGO_IN_EMAILS === \"true\"\n    const embeddedLogo = embedLogo ? getEmbeddedLogoDataUrl() : null\n    const logoSrc = embeddedLogo || (logoUrl ? logoUrl + \"/digilink-logo.png\" : \"/digilink-logo.png\")\n\n    // Generate HTML report\n    const reportHtml = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n          .container { max-width: 800px; margin: 0 auto; padding: 20px; }\n          .logo { text-align: center; margin-bottom: 30px; }\n          .logo img { max-width: 300px; height: auto; }\n          .header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; }\n          .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }\n          .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #1e3a8a; }\n          .stat-label { font-size: 14px; color: #666; margin-bottom: 5px; }\n          .stat-value { font-size: 32px; font-weight: bold; color: #333; }\n          table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n          th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }\n          th { background: #f8f9fa; font-weight: 600; }\n          .status { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }\n          .status.active { background: #d1fae5; color: #065f46; }\n          .status.expired { background: #fee2e2; color: #991b1b; }\n          .status.pending { background: #fef3c7; color: #92400e; }\n          .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #666; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>Subscription Report</h1>\n            <p>${companyName || \"Digilink IT Subscription Management System\"}</p>\n            <p>Generated on ${new Date().toLocaleDateString()}</p>\n          </div>\n\n          <div class=\"stats\">\n            <div class=\"stat-card\">\n              <div class=\"stat-label\">Total Subscriptions</div>\n              <div class=\"stat-value\">${totalSubscriptions}</div>\n            </div>\n            <div class=\"stat-card\">\n              <div class=\"stat-label\">Active Subscriptions</div>\n              <div class=\"stat-value\">${activeSubscriptions}</div>\n            </div>\n            <div class=\"stat-card\">\n              <div class=\"stat-label\">Expired Subscriptions</div>\n              <div class=\"stat-value\">${expiredSubscriptions}</div>\n            </div>\n            <div class=\"stat-card\">\n                <div class=\"stat-label\">Total Revenue</div>\n                <div class=\"stat-value\">${formatCurrency(totalRevenue)}</div>\n              </div>\n          </div>\n\n          <h2>Upcoming Renewals (Next 30 Days)</h2>\n          ${\n            upcomingRenewals.length > 0\n              ? `\n            <table>\n              <thead>\n                <tr>\n                  <th>Client Name</th>\n                  <th>Type</th>\n                  <th>Renewal Date</th>\n                  <th>Price</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${upcomingRenewals\n                  .map(\n                    (sub) => `\n                  <tr>\n                    <td>${sub.client_name}</td>\n                    <td>${sub.subscription_type}</td>\n                    <td>${new Date(sub.renewal_date).toLocaleDateString()}</td>\n                    <td>${formatCurrency(Number.parseFloat(sub.price) || 0)}</td>\n                  </tr>\n                `,\n                  )\n                  .join(\"\")}\n              </tbody>\n            </table>\n          `\n              : `<p>No upcoming renewals in the next 30 days.</p>`\n          }\n\n          <h2>All Subscriptions</h2>\n          <table>\n            <thead>\n              <tr>\n                <th>Client Name</th>\n                <th>Type</th>\n                <th>Status</th>\n                <th>End Date</th>\n                <th>Price</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${subscriptions\n                .map(\n                  (sub) => `\n                <tr>\n                  <td>${sub.client_name}</td>\n                  <td>${sub.subscription_type}</td>\n                  <td><span class=\"status ${sub.status}\">${sub.status}</span></td>\n                  <td>${new Date(sub.end_date).toLocaleDateString()}</td>\n                  <td>${formatCurrency(Number.parseFloat(sub.price) || 0)}</td>\n                </tr>\n              `,\n                )\n                .join(\"\")}\n            </tbody>\n          </table>\n\n          <div class=\"footer\">\n            <p>This is an automated report from Digilink IT Subscription Management System</p>\n            <p style=\"font-size: 12px; margin-top: 10px;\">Connecting You to the Digital World</p>\n          </div>\n        </div>\n      </body>\n      </html>\n    `\n\n    console.log(\"[v0] Sending email to:\", adminEmail)\n\n    try {\n      const emailResult = await sendEmail({\n        from: process.env.EMAIL_FROM,\n        to: adminEmail,\n        subject: `Subscription Report - ${new Date().toLocaleDateString()}`,\n        html: reportHtml,\n      })\n\n      if (!emailResult.success) {\n        console.error(\"[v0] Resend API error:\", emailResult.error)\n        return NextResponse.json(\n          { error: `Failed to send email: ${emailResult.error?.message || \"Unknown error\"}` },\n          { status: 500 },\n        )\n      }\n\n      console.log(\"[v0] Email sent successfully:\", emailResult.data)\n\n      return NextResponse.json({\n        message: \"Report sent successfully\",\n        data: emailResult.data,\n      })\n    } catch (emailError: any) {\n      console.error(\"[v0] Exception sending email:\", emailError)\n      return NextResponse.json(\n        { error: `Email service error: ${emailError.message || \"Unknown error\"}` },\n        { status: 500 },\n      )\n    }\n  } catch (error: any) {\n    console.error(\"[v0] Unexpected error generating report:\", error)\n    return NextResponse.json(\n      { error: `Failed to generate report: ${error.message || \"Unknown error\"}` },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}